# LLM ランニングコスト算出 Web システム — 料金改定運用手順書

> 本ドキュメントは [docs/requirement.md](requirement.md) に定義されたシステムを前提とした、
> モデル料金マスターデータの改定運用手順を定める。

---

## 1. 運用概要

### 1.1 対象データ

本システムが管理する料金マスターデータは以下の4テーブルで構成される（参照: [requirement.md セクション 7.3](requirement.md#73-データベース設計概要)）。

| テーブル | 内容 | 主なデータソース |
|---------|------|----------------|
| `providers` | プロバイダー情報（OpenAI, Anthropic, Google） | 新プロバイダー追加時のみ更新 |
| `models` | テキスト生成モデルの料金情報 | 各プロバイダーの公式料金ページ |
| `embedding_models` | Embedding モデルの料金情報 | 各プロバイダーの公式料金ページ |
| `web_search_tools` | Web 検索ツールの料金情報 | 各プロバイダーの公式料金ページ |

### 1.2 更新方式

マスターデータの更新はシードスクリプト（`npm run db:seed`）で行う（参照: [requirement.md セクション 7.2](requirement.md#72-構成方針)）。
管理画面は存在せず、コードベースのシードファイル（`src/lib/db/seed.ts`）を直接編集する。

### 1.3 更新頻度の目安

| 区分 | 頻度 | トリガー |
|------|------|---------|
| 定期確認 | **月1回**（毎月第1営業日を推奨） | スケジュールベース |
| 臨時確認 | 随時 | プロバイダーからの料金改定アナウンスを検知した場合 |
| 新モデル追加 | 随時 | プロバイダーが新モデルをリリースした場合 |

---

## 2. 料金情報の確認先

### 2.1 公式料金ページ一覧

| プロバイダー | 料金ページ URL | 確認対象 |
|-------------|---------------|---------|
| OpenAI | https://openai.com/api/pricing/ | テキスト生成モデル、推論モデル、Embedding モデル、Web Search |
| OpenAI（詳細） | https://platform.openai.com/docs/pricing | Batch API、Fine-tuning 等の詳細料金 |
| Anthropic | https://www.anthropic.com/pricing | テキスト生成モデル、Cache Write/Read、Web Search |
| Anthropic（詳細） | https://docs.anthropic.com/en/docs/about-claude/pricing | 詳細な料金体系 |
| Google（Vertex AI） | https://cloud.google.com/vertex-ai/generative-ai/pricing | テキスト生成モデル、Embedding、Grounding |

### 2.2 確認すべき項目

各プロバイダーの料金ページで以下の項目を確認する。

- [ ] インプットトークン単価（$/1M tokens）
- [ ] アウトプットトークン単価（$/1M tokens）
- [ ] キャッシュ関連単価（Cache Write / Cache Read / Cached Input）
- [ ] Embedding モデル単価
- [ ] Web 検索ツール単価
- [ ] 最大コンテキスト長
- [ ] 新モデルの追加・既存モデルの廃止
- [ ] 料金体系の構造変更（新しい課金区分の追加等）

---

## 3. 更新手順

### 3.1 事前準備

```
1. リポジトリの最新版を取得する
   $ git pull origin main

2. 新しいブランチを作成する
   $ git checkout -b update/pricing-YYYY-MM-DD
```

### 3.2 シードデータの編集

対象ファイル: `src/lib/db/seed.ts`

#### 3.2.1 既存モデルの料金変更

該当モデルの料金値を変更する。

変更対象のフィールド:
- `input_price_per_m_tokens` — インプット単価
- `output_price_per_m_tokens` — アウトプット単価
- `cache_write_price_per_m_tokens` — Cache Write 単価（Anthropic のみ）
- `cache_read_price_per_m_tokens` — Cache Read 単価
- `max_context_length` — 最大コンテキスト長

#### 3.2.2 新モデルの追加

以下を確認した上でシードデータにレコードを追加する:

- [ ] 所属プロバイダーの `provider_id` を確認する
- [ ] `category` を適切に設定する（flagship / standard / lightweight / reasoning）
- [ ] 全料金フィールドを公式ドキュメントから正確に転記する
- [ ] `is_legacy` を `false` に設定する
- [ ] `max_context_length` を設定する（不明な場合は null）

#### 3.2.3 モデルの廃止

廃止されたモデルは削除せず、`is_legacy` を `true` に変更する。
これにより、過去の見積もりとの整合性を維持する。

#### 3.2.4 Embedding モデルの更新

`embedding_models` テーブルのデータを更新する。
Google Embedding はオンライン/バッチの 2 件が存在することに注意する。

#### 3.2.5 Web 検索ツールの更新

`web_search_tools` テーブルのデータを更新する。
`additional_pricing_notes` に特記事項（無料枠情報等）を記載する。

### 3.3 シードスクリプトの実行

```
1. シードスクリプトを実行する
   $ npm run db:seed

2. 実行結果を確認する（エラーがないこと）
```

### 3.4 検証

#### 3.4.1 データ検証

シード実行後、以下を確認する:

- [ ] API エンドポイント（`GET /api/models`）にアクセスし、更新されたデータが返却されることを確認する
- [ ] 変更したモデルの料金値が公式ドキュメントの値と一致することを確認する
- [ ] 新規追加したモデルがレスポンスに含まれることを確認する
- [ ] 廃止したモデルの `is_legacy` が `true` になっていることを確認する

#### 3.4.2 計算結果検証

更新されたデータで計算結果が妥当であることを確認する:

- [ ] ざっくり算定モードで更新モデルを選択し、コスト算出が正常に動作することを確認する
- [ ] 詳細算定モードで更新モデルを選択し、コスト算出が正常に動作することを確認する
- [ ] 算出されたコストが手計算と一致することを確認する（1〜2パターンで十分）

#### 3.4.3 手計算による突合例

以下の条件で手計算と突合する:

```
条件例:
- モデル: [更新対象モデル]
- リクエスト数: 100回/日
- 入力: 1,000文字（日本語 → 約1,500トークン）
- 出力: 500文字（日本語 → 約750トークン）
- システムプロンプト: 2,000文字（日本語 → 約3,000トークン）
- オプション: すべてOFF
- 安全マージン: 20%

手計算:
1リクエストあたりのインプットトークン = 3,000 + 1,500 = 4,500
1リクエストあたりのアウトプットトークン = 750
1リクエストあたりのコスト = (4,500 / 1,000,000 × Input単価) + (750 / 1,000,000 × Output単価)
日次コスト = 上記 × 100
月次コスト = 日次コスト × 20 × 1.2
```

### 3.5 コミット・デプロイ

```
1. 変更をコミットする
   $ git add src/lib/db/seed.ts
   $ git commit -m "料金マスターデータ更新: YYYY-MM-DD（[変更概要]）"

2. プルリクエストを作成する
   $ git push -u origin update/pricing-YYYY-MM-DD
   （GitHub 上で PR を作成し、レビューを受ける）

3. マージ後、Vercel が自動デプロイする

4. 本番環境で更新されたデータが反映されていることを確認する
```

---

## 4. 更新記録

料金更新を実施した際は、シードファイル内のコメントまたは以下の表に記録を残す。

| 更新日 | 更新者 | 変更内容 | 確認した公式ドキュメントの日付 |
|--------|--------|---------|---------------------------|
| 2026-02-14 | — | 初期データ投入 | 2026-02-14 時点の公式料金ページ |

---

## 5. 注意事項

### 5.1 料金体系の構造変更への対応

プロバイダーが料金体系の構造自体を変更した場合（例: 新しい課金区分の追加、課金単位の変更）は、
シードデータの修正だけでは対応できない可能性がある。以下のケースではスキーマ変更を検討する:

- 新しい課金カラムが必要になった場合（例: 新しいキャッシュ方式の追加）
- 課金単位が変わった場合（例: トークン単位 → 文字単位）
- プロバイダー固有の課金ルールが追加された場合（例: 時間帯別料金）

このような場合は要件定義書（`docs/requirement.md`）の更新から着手する。

### 5.2 為替レートについて

為替レート（デフォルト 150 円/USD）はユーザーが入力時に変更可能なため、マスターデータとしては管理しない。
ただし、デフォルト値が実勢レートと大きく乖離した場合は `src/lib/constants/defaults.ts` のデフォルト値を更新する。

### 5.3 シードスクリプトの冪等性

シードスクリプトは UPSERT（存在すれば更新、なければ挿入）で実装されているため、何度実行しても安全である。
ただし、モデル名を変更した場合は旧名のレコードが残る可能性があるため注意する。
